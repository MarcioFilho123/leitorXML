<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Produtos NF-e</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .upload-area { border: 3px dashed #ddd; border-radius: 10px; padding: 40px; text-align: center; margin: 30px; }
        .new-btn { background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; transition: 0.3s; }
        .new-btn:hover { background: #5a67d8; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .results { padding: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Lista de Produtos NF-e</h1>
        </div>
        <div class="upload-area" id="uploadArea">
            <input type="file" id="xmlFile" accept=".xml" style="display:none" onchange="uploadFile()"/>
            <button class="new-btn" onclick="document.getElementById('xmlFile').click()">üìÅ Escolher XML</button>
        </div>
        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const resultsDiv = document.getElementById('results');
        
        // VARI√ÅVEL GLOBAL PARA O NOME DO ARQUIVO
        let nomeDoArquivoGlobal = ""; 

        function resetPage() { /*Reseta a p√°gina*/
            resultsDiv.style.display = 'none';
            uploadArea.style.display = 'block';
            document.getElementById('xmlFile').value = '';
            nomeDoArquivoGlobal = "";
        }

        function uploadFile() { /*envia xml*/
            const fileInput = document.getElementById('xmlFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('xml_file', file);

            uploadArea.style.display = 'none';
            resultsDiv.innerHTML = 'Processando...';
            resultsDiv.style.display = 'block';

            fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // GUARDA O NOME QUE VEIO DO PYTHON
                    nomeDoArquivoGlobal = data.nomearquivo; 
                    displayResults(data.produtos, data.total);
                } else {
                    resultsDiv.innerHTML = `Erro: ${data.error} <br><button onclick="resetPage()" class="new-btn">Voltar</button>`;
                }
            })
            .catch(() => {
                resultsDiv.innerHTML = `Erro ao processar. <br><button onclick="resetPage()" class="new-btn">Voltar</button>`;
            });
        }

        function displayResults(products, total) {
            let html = `
            <div class="action-bar">
                <button class="new-btn" onclick="document.getElementById('xmlFile').click()" style="background: #718096;" >
                    üìÅ Outro XML
                </button>
                <div style="font-weight: bold; color: #4a5568;">Total: ${total} produtos</div>
                <button onclick="downloadPDF()" style="background: #48bb78; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-weight: bold;">
                    üì• Download PDF
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>C√≥d.</th>
                        <th>Descri√ß√£o</th>
                        <th>Total</th>
                        <th>Qtd.</th>
                    </tr>
                </thead>
                <tbody>`;
            
            products.forEach(p => {
                html += `<tr>
                    <td>${p.cProd}</td>
                    <td>${p.xProd}</td>
                    <td>R$ ${parseFloat(p.vProd).toFixed(2)}</td>
                    <td>${p.qCom}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }

        function downloadPDF() {
            if (nomeDoArquivoGlobal) {
                // REDIRECIONA PARA A ROTA DE DOWNLOAD DO FLASK
                window.location.href = `/download/${nomeDoArquivoGlobal}`;
            } else {
                alert("Erro: Arquivo n√£o encontrado.");
            }
        }
    </script>
</body>
</html>
